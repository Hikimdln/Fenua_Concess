<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catalogue - Fenua Concess</title>
<link rel="icon" type="image/png" href="assets/logo1.png">
<style>
/* --- Fond flout√© --- */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: url('assets/background2.png') no-repeat center center / cover;
  filter: blur(5px);
  z-index: -1;
}

body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  color: #fff;
  position: relative;
  z-index: 1;
}

/* --- Sidebar --- */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: 220px;
  height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
  padding: 20px 10px;
  box-sizing: border-box;
  overflow-y: auto;
}
.sidebar h2 { 
  color: #fff; 
  text-align: center; 
  margin-bottom: 20px; 
}
.sidebar a { 
  display: block; 
  color: #fff; 
  text-decoration: none; 
  margin: 10px 0; 
  padding: 8px 10px; 
  border-radius: 5px; 
  transition: 0.3s; 
}
.sidebar a:hover { 
  background: rgba(255,255,255,0.1); 
}
.sidebar .logout {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 40px);
  text-align: center;
  background: #ff0000;
  color: #fff;
  padding: 10px 0;
  border-radius: 6px;
  transition: 0.3s;
}
.sidebar .logout:hover {
  background: #00b4db;
}

/* --- Header --- */
header {
  margin-left: 220px;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(6px);
  color: #fff;
  text-align: center;
  padding: 15px;
  font-size: 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  box-sizing: border-box;
}

/* --- Main content --- */
.main-content {
  margin-left: 220px;
  padding: 80px 20px 30px 20px;
  box-sizing: border-box;
  min-height: 100vh;
}

/* --- Bouton retour --- */
.back-btn {
  margin-bottom: 15px;
  padding: 10px 20px;
  background: #ff0000;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
}
.back-btn:hover { 
  background: #00b4db; 
}

/* --- Formulaire facture --- */
#factureForm {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 700px;
  margin: 0 auto;
  background: rgba(0,0,0,0.3);
  padding: 20px;
  border-radius: 15px;
  backdrop-filter: blur(6px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#factureForm label {
  font-weight: bold;
  margin-bottom: 4px;
}

#factureForm input,
#factureForm select,
#factureForm button {
  padding: 8px 10px;
  border-radius: 6px;
  border: none;
  font-size: 1rem;
  width: 100%;
  box-sizing: border-box;
}

#factureForm input[readonly] {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

#factureForm button[type="submit"] {
  background: #ff0000;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  transition: 0.3s;
}

#factureForm button[type="submit"]:hover {
  background: #00b4db;
}

/* --- Nom utilisateur / Vendeur --- */
#userBlock { text-align: center; margin-bottom: 20px; }
#usernameDisplay { font-weight: 900; font-size: 1.3rem; margin-bottom: 5px; }
#usernameLine { height: 2px; background: #fff; width: 80%; margin: 0 auto 10px auto; }

/* --- Scroll top --- */
#scrollTopBtn {
  display: none;
  position: fixed;
  bottom: 25px; right: 25px;
  z-index: 99;
  background-color: #f44336;
  color: white;
  border: none;
  border-radius: 50%;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 18px;
  transition: 0.3s;
}
#scrollTopBtn:hover { 
  background-color: #00b4db; 
}

/* --- Responsive --- */
@media (max-width: 800px) {
  .main-content { 
    margin-left: 0; 
    padding: 20px 10px; 
  }
  header { margin-left: 0; }
  #factureForm { max-width: 100%; }
  .sidebar .logout { position: relative; bottom: auto; transform: none; width: 100%; margin-top: 20px; }
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div id="userBlock">
    <div id="usernameDisplay"></div>
    <div id="usernameLine"></div>
  </div>
  <h2>Fenua Concess</h2>
  <a href="portail.html">Accueil</a>
  <a href="catalogue.html">Catalogue</a>
  <a href="factures.html">Factures</a>
  <a href="equipe.html">L'√©quipe</a>
  <a href="index.html" class="logout" id="logoutBtn">D√©connexion</a>
</div>

<header>Portail Interne - Cr√©er une facture</header>

<div class="main-content">
  <div style="width:100%;">
    <button class="back-btn" onclick="window.location.href='portail.html'">‚¨Ö Retour</button>

    <form id="factureForm">
      <label for="vendeur">Vendeur :</label>
      <input type="text" id="vendeur" readonly>

      <label for="date">Date :</label>
      <input type="date" id="date" required>

      <label for="heure">Heure :</label>
      <input type="time" id="heure" required>

      <label for="categorie">Cat√©gorie :</label>
      <select id="categorie" required>
        <option value="">-- S√©lectionner une cat√©gorie --</option>
      </select>

      <label for="vehicule">Mod√®le du v√©hicule :</label>
      <select id="vehicule" required>
        <option value="">-- S√©lectionner un v√©hicule --</option>
      </select>

      <label for="quantite">Quantit√© :</label>
      <input type="number" id="quantite" min="1" value="1" required>

      <label for="plaque">Plaque d'immatriculation :</label>
      <input type="text" id="plaque" placeholder="Ex: BCL 475" required>

      <label for="operation">Type d'op√©ration :</label>
      <select id="operation" required>
        <option value="Achat">Achat</option>
        <option value="Location">Location</option>
      </select>

      <label for="proprietaire">Identit√© du propri√©taire :</label>
      <input type="text" id="proprietaire" placeholder="Nom complet" required>

      <label for="prixUsine">Prix d'usine :</label>
      <input type="number" id="prixUsine" readonly>

      <label for="prix">Prix (TTC) :</label>
      <input type="number" id="prix" readonly>

      <label for="reduction">Remises (%) :</label>
      <input type="number" id="reduction" min="0" max="100" value="0">

      <label for="motif">Commentaires / Motifs :</label>
      <input type="text" id="motif" placeholder="Remises, fid√©lit√©, etc.">

      <label for="total">Total :</label>
      <input type="number" id="total" readonly>

      <label for="totalFinal">Total apr√®s remise :</label>
      <input type="number" id="totalFinal" readonly>

      <button type="submit">Envoyer la facture</button>
      <p id="message"></p>
    </form>
  </div>
</div>

<button id="scrollTopBtn" title="Remonter en haut">‚Üë</button>

<script>
// --- V√©rifie si l'utilisateur est connect√© ---
const user = sessionStorage.getItem('fc_user');
if(user){
  document.getElementById('vendeur').value = user;
  document.getElementById('usernameDisplay').textContent = user;
} else {
  window.location.href = "login.html";
}

// --- Bouton D√©connexion ---
document.getElementById('logoutBtn').addEventListener('click', () => {
  sessionStorage.removeItem('fc_user');
  window.location.href = 'index.html';
});

// --- CSV et cat√©gories ---
const csvData = `V√âHICULES;PRIX USINE;PRIX VENTE
COMPACTS;;
Blista;8 000;30 400
Brioso R/A;18 000;68 400
Issi;10 000;38 000
Panto;10 000;38 000
Prairie;12 000;45 600
COUP√âS;;
Cognoscenti Cabrio;55 000;209 000
Exemplar;32 000;121 600
F620;40 000;152 000
Felon;42 000;159 600
Felon GT;55 000;209 000
Jackal;38 000;144 400
Oracle XS;35 000;133 000
Sentinel;32 000;121 600
Sentinel XS;40 000;152 000
Windsor;95 000;361 000
Windsor Drop;125 000;475 000
Zion;36 000;136 800
Zion  Cabrio;45 000;171 000
GABZ;;
Pfister2;600 000;2 280 000
Argento 7F;500 000;1 900 000
Club XR;400 000;1 520 000
Pfister Comet S2 Rally Custom;1 260 000;4 788 000
Dodge charger Esperta;1 000 000;3 800 000
Gresley STX;600 000;2 280 000
Bravado Harmann;907 200;3 447 360
Biriz SZ;400 000;1 520 000
Mini Cooper S (Issi Metro);900 000;3 420 000
Toyota Hilux Mojave;1 200 000;4 560 000
Benefactor Schwartzer S;1 008 000;3 830 400
Obey Sentinel GTS;1 159 200;4 404 960
Volvo Starlight;900 000;3 420 000
TenF R;1 108 000;4 213 440
Jaguar XE SV Project 8;1 200 000;4 560 000
Mazda ZR 350;756 000;2 872 800
MOTOS;;
Akuma;7 500;28 500
Avarus;18 000;68 400
Bagger;13 500;51 300
Bati 801;12 000;45 600
Bati 801RR;19 000;72 200
BF400;6 500;24 700
BMX (V√©lo);160;608
Carbon RS;18 000;68 400
Chimera;38 000;144 400
Cliffhanger;9 500;36 100
Cruiser (V√©lo);510;1 938
Daemon;11 500;43 700
Daemon High;13 500;51 300
Defiler;9 800;37 240
Double T;28 000;106 400
Enduro;5 500;20 900
Esskey;4 200;15 960
Faggio;1 900;7 220
Vespa;2 800;10 640
Fixter (V√©lo);225;855
Gargoyle;16 500;62 700
Hakuchou;31 000;117 800
Hakuchou Sport;55 000;209 000
Hexer ;12 000;45 600
Innovation;23 500;89 300
Manchez;5 300;20 140
Nemesis;5 800;22 040
Nightblade;35 000;133 000
PCJ-600;6 200;23 560
Ruffian;6 800;25 840
Sanchez;5 300;20 140
Sanchez Sport;5 300;20 140
Sanctus;25 000;95 000
Scorcher (V√©lo);280;1 064
Shotaro Concept;320 000;1 216 000
Sovereign;22 000;83 600
Thrust;24 000;91 200
Tri bike (V√©lo);520;1 976
Vader;7 200;27 360
Vortex;9 800;37 240
Wofisbane;9 000;34 200
Zombie;9 500;36 100
Zombie luxuary;12 000;45 600
MUSCLE;;
Blade;15 000;57 000
Buccaneer;18 000;68 400
Buccaneer Rider;24 000;91 200
Chino;15 000;57 000
Chino Luxe;19 000;72 200
Coquette BlackFin;55 000;209 000
Dominator;35 000;133 000
Dukes;28 000;106 400
Faction;20 000;76 000
Faction Rider;30 000;114 000
Faction XL;40 000;152 000
Gauntlet;30 000;114 000
Hermes;535 000;2 033 000
Hotknife;125 000;475 000
Hustler;625 000;2 375 000
Nightshade;65 000;247 000
Phoenix;12 500;47 500
Picador;18 000;68 400
Ruiner 2 ;5 745 600;21 833 280
Sabre Turbo;20 000;76 000
Sabre GT;25 000;95 000
Slam Van;11 500;43 700
Tampa;16 000;60 800
Vigero;12 500;47 500
Virgo;14 000;53 200
Voodoo;7 200;27 360
Yoosemite;485 000;1 843 000
TOUT-TERRAIN;;
Bf injection;16 000;60 800
Bifta;12 000;45 600
Blazer;6 500;24 700
Blazer Sport;8 500;32 300
Blazer5;1 755 600;6 671 280
Brawler;45 000;171 000
Bubsta 6x6;120 000;456 000
Dune Buggy;8 000;30 400
Guardian;45 000;171 000
Kamacho;345 000;1 311 000
The Liberator;210 000;798 000
Rebel;35 000;133 000
Riata;380 000;1 444 000
Sandking;55 000;209 000
Trophy Truck;60 000;228 000
Trophy Truck Limited;80 000;304 000
BERLINES;;
Asea;5 500;20 900
Cognoscenti;55 000;209 000
Emperor;8 500;32 300
Fugitive;12 000;45 600
Glendale;6 500;24 700
Intruder;7 500;28 500
Premier;8 000;30 400
Primo Custom;14 000;53 200
Regina;5 000;19 000
Shafter;25 000;95 000
Stretch;90 000;342 000
Super Diamond;130 000;494 000
Tailgater;30 000;114 000
Warrener;4 000;15 200
Washington;9 000;34 200
SPORTIVES;;
Alpha;60 000;228 000
Banshee;70 000;266 000
Bestia GTS;55 000;209 000
Buffalo;12 000;45 600
Buffalo S;20 000;76 000
Carbonizzare;75 000;285 000
Comet;65 000;247 000
Comet 5;1 145 000;4 351 000
Coquette;65 000;247 000
Elegy;38 500;146 300
Feltzer;55 000;209 000
Furore GT;45 000;171 000
Fusilade;40 000;152 000
Jester;65 000;247 000
Jester (Racecar);135 000;513 000
Khamelion;38 000;144 400
Kuruma;30 000;114 000
Lynx;40 000;152 000
Mamba;70 000;266 000
Massacro;65 000;247 000
Massacro (Racecar);130 000;494 000
Neon;1 500 000;5 700 000
9F;65 000;247 000
9F Cabrio;80 000;304 000
Omnis;35 000;133 000
Pariah;1 420 000;5 396 000
Penumbra;28 000;106 400
Raiden;1 375 000;5 225 000
Rapid GT;35 000;133 000
Rapid GT Convertible;45 000;171 000
Revolter;1 610 000;6 118 000
Schafter V12;50 000;190 000
Sentinel 3;650 000;2 470 000
Seven 70;39 500;150 100
Streiter;500 000;1 900 000
Stromberg;3 185 350;12 104 330
Sultan;15 000;57 000
Surano;50 000;190 000
Drift Tampa;80 000;304 000
Tropos;40 000;152 000
Verlierer;70 000;266 000
CLASSIQUE SPORTIVES;;
Ardent;1 150 000;4 370 000
Btype;62 000;235 600
Btype Hotroad;155 000;589 000
Btype Luxe;85 000;323 000
Casco;30 000;114 000
Coquette Classic;40 000;152 000
Deluxo;4 721 500;17 941 700
Stirling GT;65 000;247 000
GT 500;785 000;2 983 000
Manana;12 800;48 640
Monroe;55 000;209 000
Pigalle;20 000;76 000
Rapid GT3;885 000;3 363 000
Retinue;615 000;2 337 000
Savestra;990 000;3 762 000
Stinger;80 000;304 000
Stinger GT;75 000;285 000
Viseris;875 000;3 325 000
Z190;900 000;3 420 000
Z-Type;220 000;836 000
SUVs;;
Baller;40 000;152 000
Baller Sport;60 000;228 000
Cavalcade;55 000;209 000
Contender;70 000;266 000
Dubsta;45 000;171 000
Dubsta Luxuary;60 000;228 000
Phantom;17 000;64 600
Grabger;50 000;190 000
Gresley;47 500;180 500
Huntley S;40 000;152 000
Landstalker;35 000;133 000
Mesa;16 000;60 800
Mesa Trail;40 000;152 000
Patriot;55 000;209 000
Radius;29 000;110 200
Rocoto;45 000;171 000
Seminole;25 000;95 000
XLS;32 000;121 600
VANS;;
Bison;45 000;171 000
Bobcat XL;32 000;121 600
Burrito;19 000;72 200
Camper;42 000;159 600
Gang Burrito;45 000;171 000
Burrito;29 000;110 200
Journey;6 500;24 700
Minivan;13 000;49 400
Moonbeam;18 000;68 400
Moonbeam Rider;35 000;133 000
Paradise;19 000;72 200
Rumpo;15 000;57 000
Rumpo Trail;19 500;74 100
Surfer;12 000;45 600
Youga;10 800;41 040
Youga Luxury;14 500;55 100
SUPER SPORTIVES;;
Adder;90 000;3 420 000
Autarch;1 955 000;7 429 000
Banshee 900R;255 000;969 000
Bullet;90 000;342 000
Cheetah;375 000;1 425 000
Cyclone;1 890 000;7 182 000
Entity XF;425 000;1 615 000
FMJ;185 000;703 000
Infernus;180 000;684 000
RE-7B;325 000;1 235 000
Oppressor;3 524 500;13 393 100
Osiris;160 000;608 000
Pfister;85 000;323 000
X80 Proto;2 500 000;9 500 000
Reaper;150 000;570 000
SC1;1 603 000;6 091 400
ETR1;220 000;836 000
Sultan RS;65 000;247 000
T20;300 000;1 140 000
Turismo R;350 000;1 330 000
Tyrus;600 000;2 280 000
Vacca;120 000;456 000
Visione;2 250 000;8 550 000
Voltic;90 000;342 000
Voltic 2;3 830 400;14 555 520
Zentorno;1 500 000;5 700 000`;

const categories = {};
let currentCat = "";
csvData.split("\n").forEach(line=>{
  if(!line.trim()) return;
  const [v, prixU, prixV] = line.split(";");
  if(prixU === "" && prixV === "") { currentCat = v; categories[currentCat] = []; return; }
  if(currentCat){
    categories[currentCat].push({
      nom: v,
      usine: parseFloat(prixU.replace(/\s/g,'')) || 0,
      prix: parseFloat(prixV.replace(/\s/g,'')) || 0
    });
  }
});

// --- Remplissage cat√©gories ---
const catSelect = document.getElementById('categorie');
const vehSelect = document.getElementById('vehicule');
const prixInput = document.getElementById('prix');
const prixUsineInput = document.getElementById('prixUsine');

Object.keys(categories).forEach(c => {
  const option = document.createElement('option');
  option.value = c;
  option.textContent = c;
  catSelect.appendChild(option);
});

// --- Quand cat√©gorie change ---
catSelect.addEventListener('change', () => {
  vehSelect.innerHTML = '<option value="">-- S√©lectionner un v√©hicule --</option>';
  const list = categories[catSelect.value] || [];
  list.forEach(v => {
    const o = document.createElement('option');
    o.value = v.nom;
    o.textContent = v.nom;
    vehSelect.appendChild(o);
  });
  prixInput.value = '';
  prixUsineInput.value = '';
  updateTotal();
});

// --- Quand v√©hicule change ---
vehSelect.addEventListener('change', () => {
  const list = categories[catSelect.value] || [];
  const selected = list.find(x => x.nom === vehSelect.value);
  if(selected){
    prixInput.value = selected.prix;
    prixUsineInput.value = selected.usine;
  } else {
    prixInput.value = '';
    prixUsineInput.value = '';
  }
  updateTotal();
});

// --- Calcul total ---
const quantInput = document.getElementById('quantite');
const reductionInput = document.getElementById('reduction');
const totalInput = document.getElementById('total');
const totalFinalInput = document.getElementById('totalFinal');

function updateTotal(){
  const prix = parseFloat(prixInput.value)||0;
  const qte = parseInt(quantInput.value)||1;
  const reduc = parseFloat(reductionInput.value)||0;
  const total = prix*qte;
  totalInput.value = total.toFixed(0);
  totalFinalInput.value = reduc>0 ? (total - total*reduc/100).toFixed(0) : total.toFixed(0);
}

quantInput.addEventListener('input', updateTotal);
reductionInput.addEventListener('input', updateTotal);

// --- Scroll top bouton ---
const scrollBtn = document.getElementById("scrollTopBtn");
window.onscroll = function() {
  scrollBtn.style.display = document.body.scrollTop > 200 || document.documentElement.scrollTop > 200 ? "block" : "none";
};
scrollBtn.addEventListener("click", ()=> window.scrollTo({top:0, behavior:'smooth'}));

// --- Soumission formulaire ---
document.getElementById('factureForm').addEventListener('submit', e=>{
  e.preventDefault();
  updateTotal();
  alert("Facture pr√™te √† √™tre envoy√©e !\nTotal final : "+totalFinalInput.value);
});

document.getElementById('factureForm').addEventListener('submit', async e=>{
  e.preventDefault();
  updateTotal();

  const payload = {
    vendeur: document.getElementById('vendeur').value,
    date: document.getElementById('date').value,
    heure: document.getElementById('heure').value,
    categorie: document.getElementById('categorie').value,
    vehicule: document.getElementById('vehicule').value,
    quantite: document.getElementById('quantite').value,
    plaque: document.getElementById('plaque').value,
    operation: document.getElementById('operation').value,
    proprietaire: document.getElementById('proprietaire').value,
    prixUsine: document.getElementById('prixUsine').value,
    prixTTC: document.getElementById('prix').value,
    remise: document.getElementById('reduction').value,
    totalFinal: document.getElementById('totalFinal').value,
    commentaires: document.getElementById('motif').value || "Aucun"
  };

  // --- Envoi Google Sheets ---
  try {
    const sheetResponse = await fetch("https://script.google.com/macros/s/AKfycbwyxboz1nvvL4DXAuCCc3bgPi_pgDHRrCo9Fpear9dn0tJhcOdslR5UB1ecaeLiivLaNg/exec", {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const result = await sheetResponse.json();
    if(result.status === "success"){
      console.log("‚úÖ Facture ajout√©e sur Google Sheets !");
    } else {
      console.error("‚ùå Erreur Google Sheets :", result.message);
    }
  } catch(err){
    console.error("‚ö†Ô∏è Impossible d'envoyer sur Google Sheets :", err);
  }

  // --- Envoi Discord (existant) ---
  const discordData = {
    username: "Fenua Concess - Facture",
    embeds: [{
      title: "üìÑ Nouvelle facture cr√©√©e",
      color: 0xff0000,
      fields: [
        { name: "üßë‚Äçüíº Vendeur", value: payload.vendeur, inline: true },
        { name: "üìÖ Date", value: payload.date, inline: true },
        { name: "‚è∞ Heure", value: payload.heure, inline: true },
        { name: "üöó Cat√©gorie", value: payload.categorie, inline: true },
        { name: "üöò V√©hicule", value: payload.vehicule, inline: true },
        { name: "üî¢ Quantit√©", value: payload.quantite, inline: true },
        { name: "üè∑ Plaque", value: payload.plaque, inline: true },
        { name: "üîÑ Op√©ration", value: payload.operation, inline: true },
        { name: "üë§ Propri√©taire", value: payload.proprietaire, inline: true },
        { name: "üè≠ Prix d'usine", value: payload.prixUsine, inline: true },
        { name: "üí∞ Prix TTC", value: payload.prixTTC, inline: true },
        { name: "üéÅ Remise (%)", value: payload.remise, inline: true },
        { name: "üßæ Total final", value: payload.totalFinal, inline: true },
        { name: "üìù Commentaires", value: payload.commentaires }
      ],
      timestamp: new Date()
    }]
  };

  const webhookUrl = "https://discord.com/api/webhooks/1434167082018406530/h1MrBR0pL38eORKh0v85Y4DE2JMh0nS83J--pSdlmPsFMk64QHJb2X7Ajm-2XOjJ9wsb";

  try {
    const response = await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(discordData)
    });
if(response.ok){
  alert("‚úÖ Facture envoy√©e sur Discord et Google Sheets avec succ√®s !");
  document.getElementById('factureForm').reset();
  updateTotal();

  // ‚úÖ R√©actualiser la page apr√®s 1 seconde
  setTimeout(() => {
    location.reload();
  }, 1000);
} else {
  alert("‚ùå Erreur lors de l'envoi sur Discord.");
}

  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Impossible d'envoyer la facture. V√©rifiez votre webhook.");
  }
});


</script>
</body>
</html>
