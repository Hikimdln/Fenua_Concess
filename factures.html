<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Factures - Fenua Concess</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/png" href="assets/logo1.png">
<style>
/* --- Main content --- */
.main-content {
  margin-left:220px;
  padding:80px 30px 30px 30px;
  flex:1;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  box-sizing:border-box;
}

/* --- Formulaire --- */
form#factureForm {
  width:100%;
  max-width:600px;
  display:flex;
  flex-direction:column;
}

form#factureForm label {
  margin-top:10px;
  margin-bottom:5px;
  font-weight:600;
}

form#factureForm input, form#factureForm select, form#factureForm button {
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:16px;
}

form#factureForm button {
  margin-top:20px;
  background:#ff0000;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
  transition:0.3s;
}

form#factureForm button:hover {
  background:#00b4db;
}

/* --- Back button --- */
.back-btn {
  margin-bottom:15px;
  padding:10px 20px;
  background:#ff0000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition:0.3s;
}

.back-btn:hover {
  background:#00b4db;
}

/* --- Sidebar user --- */
#userBlock {
  text-align: center;
  padding: 20px 10px 10px 10px;
}

#usernameDisplay {
  font-weight: 900;
  font-size: 1.3rem;
  margin-bottom: 5px;
}

#usernameLine {
  height: 2px;
  background: #fff;
  margin-bottom: 10px;
  width: 80%;
  margin-left:auto;
  margin-right:auto;
}

/* scroll top button basic positioning */
#scrollTopBtn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 100;
  background: #ff0000;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 24px;
  cursor: pointer;
  display: none;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
#scrollTopBtn:hover { background:#00b4db; }
</style>
<script src="auth.js"></script>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div id="userBlock">
    <div id="usernameDisplay"></div>
    <div id="usernameLine"></div>
  </div>
  <h2>Fenua Concess</h2>
  <a href="portail.html">Accueil</a>
  <a href="catalogue.html">Catalogue</a>
  <a href="factures.html">Factures</a>
  <a href="index.html" class="logout" id="logoutBtn">D√©connexion</a>
</div>

<header>Portail Interne - Cr√©er une facture</header>

<div class="main-content">
  <div style="width:100%;">
    <button class="back-btn" onclick="window.location.href='portail.html'">‚¨Ö Retour</button>

    <form id="factureForm">
      <label for="client">Nom du client :</label>
      <input type="text" id="client" placeholder="Nom du client" required>

      <label for="vendeur">Nom du vendeur :</label>
      <input type="text" id="vendeur" readonly>

      <label for="date">Date :</label>
      <input type="date" id="date" required>

      <label for="heure">Heure :</label>
      <input type="time" id="heure" required>

      <label for="categorie">Cat√©gorie :</label>
      <select id="categorie" required>
        <option value="">-- S√©lectionner une cat√©gorie --</option>
      </select>

      <label for="vehicule">V√©hicule :</label>
      <select id="vehicule" required>
        <option value="">-- S√©lectionner un v√©hicule --</option>
      </select>

      <label for="quantite">Quantit√© :</label>
      <input type="number" id="quantite" min="1" value="1" required>

      <label for="prix">Prix unitaire :</label>
      <input type="number" id="prix" min="0" required readonly>

      <label for="reduction">R√©duction (%) :</label>
      <input type="number" id="reduction" min="0" max="100" value="0">

      <label for="motif">Motif de r√©duction (optionnel) :</label>
      <input type="text" id="motif" placeholder="Ex: remise fid√©lit√©, offre sp√©ciale...">

      <label for="total">Total :</label>
      <input type="number" id="total" readonly>

      <label for="totalFinal">Total apr√®s r√©duction :</label>
      <input type="number" id="totalFinal" readonly>

      <button type="submit">Envoyer la facture</button>
      <p id="message"></p>
    </form>
  </div>
</div>

<button id="scrollTopBtn" title="Remonter en haut">‚Üë</button>

<script>
// --- V√©rifie si l'utilisateur est connect√© ---
const user = sessionStorage.getItem('fc_user');
if(user){
  document.getElementById('vendeur').value = user;
  document.getElementById('usernameDisplay').textContent = user;
} else {
  // pas connect√©, redirection
  window.location.href = "login.html";
}

// --- Bouton D√©connexion ---
document.getElementById('logoutBtn').addEventListener('click', () => {
  sessionStorage.removeItem('fc_user');
  window.location.href = 'index.html';
});

// --- CSV complet (int√©gr√© tel que fourni) ---
const csvData = `V√âHICULES;PRIX USINE;PRIX VENTE
COMPACTS;;
Blista;8 000;30 400
Brioso R/A;18 000;68 400
Issi;10 000;38 000
Panto;10 000;38 000
Prairie;12 000;45 600
COUP√âS;;
Cognoscenti Cabrio;55 000;209 000
Exemplar;32 000;121 600
F620;40 000;152 000
Felon;42 000;159 600
Felon GT;55 000;209 000
Jackal;38 000;144 400
Oracle XS;35 000;133 000
Sentinel;32 000;121 600
Sentinel XS;40 000;152 000
Windsor;95 000;361 000
Windsor Drop;125 000;475 000
Zion;36 000;136 800
Zion  Cabrio;45 000;171 000
GABZ;;
Pfister2;600 000;2 280 000
Argento 7F;500 000;1 900 000
Club XR;400 000;1 520 000
Pfister Comet S2 Rally Custom;1 260 000;4 788 000
Dodge charger Esperta;1 000 000;3 800 000
Gresley STX;600 000;2 280 000
Bravado Harmann;907 200;3 447 360
Biriz SZ;400 000;1 520 000
Mini Cooper S (Issi Metro);900 000;3 420 000
Toyota Hilux Mojave;1 200 000;4 560 000
Benefactor Schwartzer S;1 008 000;3 830 400
Obey Sentinel GTS;1 159 200;4 404 960
Volvo Starlight;900 000;3 420 000
TenF R;1 108 000;4 213 440
Jaguar XE SV Project 8;1 200 000;4 560 000
Mazda ZR 350;756 000;2 872 800
MOTOS;;
Akuma;7 500;28 500
Avarus;18 000;68 400
Bagger;13 500;51 300
Bati 801;12 000;45 600
Bati 801RR;19 000;72 200
BF400;6 500;24 700
BMX (V√©lo);160;608
Carbon RS;18 000;68 400
Chimera;38 000;144 400
Cliffhanger;9 500;36 100
Cruiser (V√©lo);510;1 938
Daemon;11 500;43 700
Daemon High;13 500;51 300
Defiler;9 800;37 240
Double T;28 000;106 400
Enduro;5 500;20 900
Esskey;4 200;15 960
Faggio;1 900;7 220
Vespa;2 800;10 640
Fixter (V√©lo);225;855
Gargoyle;16 500;62 700
Hakuchou;31 000;117 800
Hakuchou Sport;55 000;209 000
Hexer ;12 000;45 600
Innovation;23 500;89 300
Manchez;5 300;20 140
Nemesis;5 800;22 040
Nightblade;35 000;133 000
PCJ-600;6 200;23 560
Ruffian;6 800;25 840
Sanchez;5 300;20 140
Sanchez Sport;5 300;20 140
Sanctus;25 000;95 000
Scorcher (V√©lo);280;1 064
Shotaro Concept;320 000;1 216 000
Sovereign;22 000;83 600
Thrust;24 000;91 200
Tri bike (V√©lo);520;1 976
Vader;7 200;27 360
Vortex;9 800;37 240
Wofisbane;9 000;34 200
Zombie;9 500;36 100
Zombie luxuary;12 000;45 600
MUSCLE;;
Blade;15 000;57 000
Buccaneer;18 000;68 400
Buccaneer Rider;24 000;91 200
Chino;15 000;57 000
Chino Luxe;19 000;72 200
Coquette BlackFin;55 000;209 000
Dominator;35 000;133 000
Dukes;28 000;106 400
Faction;20 000;76 000
Faction Rider;30 000;114 000
Faction XL;40 000;152 000
Gauntlet;30 000;114 000
Hermes;535 000;2 033 000
Hotknife;125 000;475 000
Hustler;625 000;2 375 000
Nightshade;65 000;247 000
Phoenix;12 500;47 500
Picador;18 000;68 400
Ruiner 2 ;5 745 600;21 833 280
Sabre Turbo;20 000;76 000
Sabre GT;25 000;95 000
Slam Van;11 500;43 700
Tampa;16 000;60 800
Vigero;12 500;47 500
Virgo;14 000;53 200
Voodoo;7 200;27 360
Yoosemite;485 000;1 843 000
TOUT-TERRAIN;;
Bf injection;16 000;60 800
Bifta;12 000;45 600
Blazer;6 500;24 700
Blazer Sport;8 500;32 300
Blazer5;1 755 600;6 671 280
Brawler;45 000;171 000
Bubsta 6x6;120 000;456 000
Dune Buggy;8 000;30 400
Guardian;45 000;171 000
Kamacho;345 000;1 311 000
The Liberator;210 000;798 000
Rebel;35 000;133 000
Riata;380 000;1 444 000
Sandking;55 000;209 000
Trophy Truck;60 000;228 000
Trophy Truck Limited;80 000;304 000
BERLINES;;
Asea;5 500;20 900
Cognoscenti;55 000;209 000
Emperor;8 500;32 300
Fugitive;12 000;45 600
Glendale;6 500;24 700
Intruder;7 500;28 500
Premier;8 000;30 400
Primo Custom;14 000;53 200
Regina;5 000;19 000
Shafter;25 000;95 000
Stretch;90 000;342 000
Super Diamond;130 000;494 000
Tailgater;30 000;114 000
Warrener;4 000;15 200
Washington;9 000;34 200
SPORTIVES;;
Alpha;60 000;228 000
Banshee;70 000;266 000
Bestia GTS;55 000;209 000
Buffalo;12 000;45 600
Buffalo S;20 000;76 000
Carbonizzare;75 000;285 000
Comet;65 000;247 000
Comet 5;1 145 000;4 351 000
Coquette;65 000;247 000
Elegy;38 500;146 300
Feltzer;55 000;209 000
Furore GT;45 000;171 000
Fusilade;40 000;152 000
Jester;65 000;247 000
Jester (Racecar);135 000;513 000
Khamelion;38 000;144 400
Kuruma;30 000;114 000
Lynx;40 000;152 000
Mamba;70 000;266 000
Massacro;65 000;247 000
Massacro (Racecar);130 000;494 000
Neon;1 500 000;5 700 000
9F;65 000;247 000
9F Cabrio;80 000;304 000
Omnis;35 000;133 000
Pariah;1 420 000;5 396 000
Penumbra;28 000;106 400
Raiden;1 375 000;5 225 000
Rapid GT;35 000;133 000
Rapid GT Convertible;45 000;171 000
Revolter;1 610 000;6 118 000
Schafter V12;50 000;190 000
Sentinel 3;650 000;2 470 000
Seven 70;39 500;150 100
Streiter;500 000;1 900 000
Stromberg;3 185 350;12 104 330
Sultan;15 000;57 000
Surano;50 000;190 000
Drift Tampa;80 000;304 000
Tropos;40 000;152 000
Verlierer;70 000;266 000
CLASSIQUE SPORTIVES;;
Ardent;1 150 000;4 370 000
Btype;62 000;235 600
Btype Hotroad;155 000;589 000
Btype Luxe;85 000;323 000
Casco;30 000;114 000
Coquette Classic;40 000;152 000
Deluxo;4 721 500;17 941 700
Stirling GT;65 000;247 000
GT 500;785 000;2 983 000
Manana;12 800;48 640
Monroe;55 000;209 000
Pigalle;20 000;76 000
Rapid GT3;885 000;3 363 000
Retinue;615 000;2 337 000
Savestra;990 000;3 762 000
Stinger;80 000;304 000
Stinger GT;75 000;285 000
Viseris;875 000;3 325 000
Z190;900 000;3 420 000
Z-Type;220 000;836 000
SUVs;;
Baller;40 000;152 000
Baller Sport;60 000;228 000
Cavalcade;55 000;209 000
Contender;70 000;266 000
Dubsta;45 000;171 000
Dubsta Luxuary;60 000;228 000
Phantom;17 000;64 600
Grabger;50 000;190 000
Gresley;47 500;180 500
Huntley S;40 000;152 000
Landstalker;35 000;133 000
Mesa;16 000;60 800
Mesa Trail;40 000;152 000
Patriot;55 000;209 000
Radius;29 000;110 200
Rocoto;45 000;171 000
Seminole;25 000;95 000
XLS;32 000;121 600
VANS;;
Bison;45 000;171 000
Bobcat XL;32 000;121 600
Burrito;19 000;72 200
Camper;42 000;159 600
Gang Burrito;45 000;171 000
Burrito;29 000;110 200
Journey;6 500;24 700
Minivan;13 000;49 400
Moonbeam;18 000;68 400
Moonbeam Rider;35 000;133 000
Paradise;19 000;72 200
Rumpo;15 000;57 000
Rumpo Trail;19 500;74 100
Surfer;12 000;45 600
Youga;10 800;41 040
Youga Luxury;14 500;55 100
SUPER SPORTIVES;;
Adder;90 000;3 420 000
Autarch;1 955 000;7 429 000
Banshee 900R;255 000;969 000
Bullet;90 000;342 000
Cheetah;375 000;1 425 000
Cyclone;1 890 000;7 182 000
Entity XF;425 000;1 615 000
FMJ;185 000;703 000
Infernus;180 000;684 000
RE-7B;325 000;1 235 000
Oppressor;3 524 500;13 393 100
Osiris;160 000;608 000
Pfister;85 000;323 000
X80 Proto;2 500 000;9 500 000
Reaper;150 000;570 000
SC1;1 603 000;6 091 400
ETR1;220 000;836 000
Sultan RS;65 000;247 000
T20;300 000;1 140 000
Turismo R;350 000;1 330 000
Tyrus;600 000;2 280 000
Vacca;120 000;456 000
Visione;2 250 000;8 550 000
Voltic;90 000;342 000
Voltic 2;3 830 400;14 555 520
Zentorno;1 500 000;5 700 000`;

// --- Parsing CSV et remplissage cat√©gories / v√©hicules ---
const lignes = csvData.trim().split("\n");
const categories = {};
let currentCat = "";
for(let i=1;i<lignes.length;i++){
  // split by ; but keep entries trim-safe
  const parts = lignes[i].split(";");
  const nom = (parts[0]||"").trim();
  const usine = (parts[1]||"").trim();
  const vente = (parts[2]||"").trim();
  if(nom && !usine && !vente){
    currentCat = nom;
    categories[currentCat] = [];
  } else if(currentCat && nom){
    // parse prix vente to number (may contain spaces)
    const prixNum = vente ? parseFloat(vente.replace(/\s/g, '')) : 0;
    categories[currentCat].push({ nom: nom, prix: prixNum });
  }
}

const catSelect = document.getElementById('categorie');
const vehSelect = document.getElementById('vehicule');
const prixInput = document.getElementById('prix');
const quantiteInput = document.getElementById('quantite');
const reductionInput = document.getElementById('reduction');
const totalInput = document.getElementById('total');
const totalFinalInput = document.getElementById('totalFinal');

Object.keys(categories).forEach(cat=>{
  const opt = document.createElement('option');
  opt.value = cat;
  opt.textContent = cat;
  catSelect.appendChild(opt);
});

// quand cat√©gorie change
catSelect.addEventListener('change', ()=>{
  vehSelect.innerHTML = '<option value="">-- S√©lectionner un v√©hicule --</option>';
  prixInput.value = '';
  totalInput.value = '';
  totalFinalInput.value = '';
  const list = categories[catSelect.value] || [];
  list.forEach(v => {
    const o = document.createElement('option');
    o.value = v.nom;
    o.textContent = v.nom;
    vehSelect.appendChild(o);
  });
});

// quand v√©hicule change
vehSelect.addEventListener('change', ()=>{
  const list = categories[catSelect.value] || [];
  const selected = list.find(x => x.nom === vehSelect.value);
  prixInput.value = selected ? selected.prix : '';
  updateTotal();
});

// calculs
quantiteInput.addEventListener('input', updateTotal);
reductionInput.addEventListener('input', updateTotal);

function updateTotal() {
  const prix = parseFloat(document.getElementById('prix').value) || 0;
  const qte = parseInt(document.getElementById('quantite').value) || 1;
  const reduc = parseFloat(document.getElementById('reduction').value) || 0;

  const total = prix * qte;
  document.getElementById('total').value = total.toFixed(0);

  // Si r√©duction > 0, on calcule et affiche le total r√©duit
  if (reduc > 0) {
    const totalReduit = total - (total * reduc / 100);
    document.getElementById('totalFinal').value = totalReduit.toFixed(0);
  } 
  // Sinon, on laisse vide
  else {
    document.getElementById('totalFinal').value = "";
  }
}


// --- Envoi au webhook Discord (utilise ton webhook exact ci-dessous) ---
document.getElementById('factureForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // recalc au cas o√π
  updateTotal();

  const client = document.getElementById('client').value.trim();
  const vendeur = document.getElementById('vendeur').value.trim();
  const date = document.getElementById('date').value;
  const heure = document.getElementById('heure').value;
  const categorie = document.getElementById('categorie').value;
  const vehicule = document.getElementById('vehicule').value;
  const quantite = document.getElementById('quantite').value;
  const prixUnitaire = document.getElementById('prix').value;
  const reduction = document.getElementById('reduction').value;
  const motif = document.getElementById('motif').value || "Aucun";
  const total = document.getElementById('totalFinal').value;

const embed = {
  title: "üßæ Nouvelle facture - Fenua Concess",
  color: 0xff0000,
  fields: [
    { name: "üë§ Client", value: client || "‚Äî", inline: true },
    { name: "üíº Vendeur", value: vendeur || "‚Äî", inline: true },
    { 
      name: "üìÖ Date", 
      value: (date 
        ? new Date(date).toLocaleDateString('fr-FR') + (heure ? ` ${heure}` : "") 
        : "‚Äî"), 
      inline: false 
    },
    { name: "üöó Cat√©gorie", value: categorie || "‚Äî", inline: true },
    { name: "üöò V√©hicule", value: vehicule || "‚Äî", inline: true },
    { name: "üî¢ Quantit√©", value: quantite.toString() || "0", inline: true },
    { name: "üí∞ Prix unitaire", value: (prixUnitaire ? Number(prixUnitaire).toLocaleString() + " $" : "‚Äî"), inline: true },
    { name: "üìâ R√©duction", value: (reduction ? reduction + " %" : "0 %"), inline: true },
    { name: "üéüÔ∏è Motif", value: motif || "Aucun", inline: false },
    { name: "üíµ Total apr√®s r√©duction", value: (total ? Number(total).toLocaleString() + " $" : "0 $"), inline: false }
  ],
  footer: { text: "Fenua Concess - Portail Interne" },
  timestamp: new Date().toISOString()
};


  // --> Remplace ci-dessous par TON webhook r√©el (d√©j√† fourni dans la conversation)
  const webhookURL = 'https://discord.com/api/webhooks/1434167082018406530/h1MrBR0pL38eORKh0v85Y4DE2JMh0nS83J--pSdlmPsFMk64QHJb2X7Ajm-2XOjJ9wsb';

  try {
    const res = await fetch(webhookURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ embeds: [embed] })
    });

    const msgEl = document.getElementById('message');
    if(res.ok){
      msgEl.textContent = '‚úÖ Facture envoy√©e sur Discord !';
      msgEl.style.color = 'green';
      document.getElementById('factureForm').reset();
      // remettre vendeur / user affich√©
      if(user){
        document.getElementById('vendeur').value = user;
        document.getElementById('usernameDisplay').textContent = user;
      }
      totalInput.value = '';
      totalFinalInput.value = '';
    } else {
      msgEl.textContent = '‚ùå Erreur lors de l\'envoi (webhook).';
      msgEl.style.color = 'red';
      console.error('Webhook status:', res.status, await res.text());
    }
  } catch (err) {
    console.error(err);
    const msgEl = document.getElementById('message');
    msgEl.textContent = '‚ùå Erreur lors de l\'envoi (r√©seau).';
    msgEl.style.color = 'red';
  }
});

// --- Bouton remonter en haut ---
const scrollBtn = document.getElementById('scrollTopBtn');
window.onscroll = function() {
  scrollBtn.style.display = (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) ? "block" : "none";
};
scrollBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

// --- Bloquer clic droit / inspecteur ---
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if(e.key === "F12" || e.keyCode === 123) e.preventDefault();
  if(e.ctrlKey && e.shiftKey && ['I','J','C'].includes((e.key||'').toUpperCase())) e.preventDefault();
  if(e.ctrlKey && ((e.key||'').toUpperCase() === 'U' || e.keyCode === 85)) e.preventDefault();
});
document.addEventListener('dragstart', e => e.preventDefault());
document.addEventListener('selectstart', e => e.preventDefault());
</script>

</body>
</html>
